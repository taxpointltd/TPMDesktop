/**
 * Core Philosophy:
 * This ruleset enforces a strict, multi-tenant user-ownership model. All data is
 * hierarchically nested under a specific user's ID (`/users/{userId}`). This
 * ensures that a user can only ever access their own data tree, providing strong
 * data isolation between different users of the application.
 *
 * Authorization is based entirely on the `userId` present in the document path.
 * This path-based security model is highly performant and secure.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * Helper function to check if the user's UID matches the {userId} in the path.
     * This is the cornerstone of the user-ownership model.
     */
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    /**
     * @description
     *   Manages user profile documents. A user can create their own profile, but
     *   cannot see or list other users' profiles.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false; // Disallow listing all users for security.
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update, delete: if isOwner(userId);

      /**
       * @description
       *   Secures the 'companies' subcollection. Access is granted if the user
       *   owns the parent user document.
       */
      match /companies/{companyId} {
        // Allow the owner to read, write, and list their own companies.
        allow read, write: if isOwner(userId);

        /**
         * @description
         *   Secures all subcollections under a company (vendors, customers, etc.).
         *   If a user owns the company (via the {userId} in the path), they have
         *   full read and write access to these subcollections. This is an
         *   inherited permissions model.
         */
        match /{subcollection}/{docId} {
          allow read, write: if isOwner(userId);
        }
      }
    }
  }
}
